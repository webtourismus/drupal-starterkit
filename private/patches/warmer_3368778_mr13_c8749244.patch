From c961793dc7275de1513c448c3b645ffbd8a2aea0 Mon Sep 17 00:00:00 2001
From: Andrew Morton <mail@andrewmorton.info>
Date: Thu, 22 Jun 2023 11:20:32 -0700
Subject: [PATCH 1/3] 3368778: Fix use of queue.commands service

---
 drush.services.yml              |  2 +-
 src/Commands/WarmerCommands.php | 18 +++++-------------
 2 files changed, 6 insertions(+), 14 deletions(-)

diff --git a/drush.services.yml b/drush.services.yml
index 2e6c263..1860dac 100644
--- a/drush.services.yml
+++ b/drush.services.yml
@@ -1,6 +1,6 @@
 services:
   warmer.commands:
     class: \Drupal\warmer\Commands\WarmerCommands
-    arguments: ['@plugin.manager.warmer', '@warmer.queue_manager', '@queue.commands']
+    arguments: ['@plugin.manager.warmer', '@warmer.queue_manager']
     tags:
       - { name: drush.command }
diff --git a/src/Commands/WarmerCommands.php b/src/Commands/WarmerCommands.php
index eed20b1..fb2323e 100644
--- a/src/Commands/WarmerCommands.php
+++ b/src/Commands/WarmerCommands.php
@@ -5,18 +5,19 @@ namespace Drupal\warmer\Commands;
 use Consolidation\AnnotatedCommand\CommandData;
 use Consolidation\AnnotatedCommand\CommandError;
 use Consolidation\OutputFormatters\StructuredData\RowsOfFields;
+use Consolidation\SiteAlias\SiteAliasManagerAwareTrait;
 use Drupal\warmer\HookImplementations;
 use Drupal\warmer\Plugin\WarmerPluginBase;
 use Drupal\warmer\Plugin\WarmerPluginManager;
 use Drupal\warmer\QueueManager;
 use Drush\Commands\DrushCommands;
-use Drush\Drupal\Commands\core\QueueCommands;
 use Drush\Utils\StringUtils;
 
 /**
  * Drush commands for the Warmer module.
  */
 class WarmerCommands extends DrushCommands {
+  use SiteAliasManagerAwareTrait;
 
   private const VERY_HIGH_NUMBER = 99999999;
 
@@ -34,13 +35,6 @@ class WarmerCommands extends DrushCommands {
    */
   private $queueManager;
 
-  /**
-   * The queue commands.
-   *
-   * @var \Drush\Drupal\Commands\core\QueueCommands
-   */
-  private $queueCommands;
-
   /**
    * WarmerCommands constructor.
    *
@@ -48,14 +42,11 @@ class WarmerCommands extends DrushCommands {
    *   The warmer manager.
    * @param \Drupal\warmer\QueueManager $queue_manager
    *   The queue manager.
-   * @param \Drush\Drupal\Commands\core\QueueCommands $queue_commands
-   *   The service related to queue commands.
    */
-  public function __construct(WarmerPluginManager $warmer_manager, QueueManager $queue_manager, QueueCommands $queue_commands) {
+  public function __construct(WarmerPluginManager $warmer_manager, QueueManager $queue_manager) {
     parent::__construct();
     $this->warmerManager = $warmer_manager;
     $this->queueManager = $queue_manager;
-    $this->queueCommands = $queue_commands;
   }
 
   /**
@@ -111,7 +102,8 @@ class WarmerCommands extends DrushCommands {
       return;
     }
     $this->logger()->success(dt('Warming caches in @count batches from the "warmer" queue.', ['@count' => $batch_count]));
-    $this->queueCommands->run('warmer', ['time-limit' => static::VERY_HIGH_NUMBER]);
+
+    $this->processManager()->drush($this->siteAliasManager()->getSelf(), 'queue:run', ['warmer'], ['time-limit' => static::VERY_HIGH_NUMBER]);
   }
 
   /**
-- 
GitLab


From 4d69ea85c0658e8310eb1b1f3e524c3eba9d6f73 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Mateu=20Aguil=C3=B3=20Bosch=20=28e0ipso=29?=
 <mateu@mateuaguilo.com>
Date: Fri, 23 Jun 2023 07:14:43 +0200
Subject: [PATCH 2/3] fix: avoid drush.services.yml

---
 composer.json                   | 10 ++--------
 drush.services.yml              |  6 ------
 src/Commands/WarmerCommands.php | 12 ++++++++++++
 3 files changed, 14 insertions(+), 14 deletions(-)
 delete mode 100644 drush.services.yml

diff --git a/composer.json b/composer.json
index 28188d7..63bc7c9 100644
--- a/composer.json
+++ b/composer.json
@@ -10,13 +10,7 @@
     ],
     "require": {
         "php": ">=5.6.0",
-        "vipnytt/sitemapparser": "^1.0"
-    },
-    "extra": {
-        "drush": {
-            "services": {
-                "drush.services.yml": "^9"
-            }
-        }
+        "vipnytt/sitemapparser": "^1.0",
+        "drush/drush": "^11.6 || ^12"
     }
 }
diff --git a/drush.services.yml b/drush.services.yml
deleted file mode 100644
index 1860dac..0000000
--- a/drush.services.yml
+++ /dev/null
@@ -1,6 +0,0 @@
-services:
-  warmer.commands:
-    class: \Drupal\warmer\Commands\WarmerCommands
-    arguments: ['@plugin.manager.warmer', '@warmer.queue_manager']
-    tags:
-      - { name: drush.command }
diff --git a/src/Commands/WarmerCommands.php b/src/Commands/WarmerCommands.php
index fb2323e..7d3c3a7 100644
--- a/src/Commands/WarmerCommands.php
+++ b/src/Commands/WarmerCommands.php
@@ -6,6 +6,7 @@ use Consolidation\AnnotatedCommand\CommandData;
 use Consolidation\AnnotatedCommand\CommandError;
 use Consolidation\OutputFormatters\StructuredData\RowsOfFields;
 use Consolidation\SiteAlias\SiteAliasManagerAwareTrait;
+use Drupal\Component\DependencyInjection\ContainerInterface;
 use Drupal\warmer\HookImplementations;
 use Drupal\warmer\Plugin\WarmerPluginBase;
 use Drupal\warmer\Plugin\WarmerPluginManager;
@@ -49,6 +50,17 @@ class WarmerCommands extends DrushCommands {
     $this->queueManager = $queue_manager;
   }
 
+
+  /**
+   * {@inheritdoc}
+   */
+  public static function create(ContainerInterface $container): self {
+    return new static(
+      $container->get('plugin.manager.warmer'),
+      $container->get('warmer.queue_manager')
+    );
+  }
+
   /**
    * Enqueue specific warmer plugins.
    *
-- 
GitLab


From c87492443712f218734f2a82fc8b50303490d426 Mon Sep 17 00:00:00 2001
From: "Christopher C. Wells" <44694-wells@users.noreply.drupalcode.org>
Date: Thu, 7 Sep 2023 16:24:13 +0000
Subject: [PATCH 3/3] Move command to Drush\Commands namespace

---
 src/{ => Drush}/Commands/WarmerCommands.php | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)
 rename src/{ => Drush}/Commands/WarmerCommands.php (99%)

diff --git a/src/Commands/WarmerCommands.php b/src/Drush/Commands/WarmerCommands.php
similarity index 99%
rename from src/Commands/WarmerCommands.php
rename to src/Drush/Commands/WarmerCommands.php
index 7d3c3a7..e0945e8 100644
--- a/src/Commands/WarmerCommands.php
+++ b/src/Drush/Commands/WarmerCommands.php
@@ -1,6 +1,6 @@
 <?php
 
-namespace Drupal\warmer\Commands;
+namespace Drupal\warmer\Drush\Commands;
 
 use Consolidation\AnnotatedCommand\CommandData;
 use Consolidation\AnnotatedCommand\CommandError;
-- 
GitLab

